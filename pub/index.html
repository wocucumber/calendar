Calendar///
<style>
    
    .user-profile > span{
        font-size: 6rem;
        position: fixed;
        top: 5px;
        right: 5px;
        cursor: pointer;
        overflow: hidden;
        border-radius: 50%;
        background: white;
        
        color: #000;
    }

    .calendar-wrapper{
        display: flex;
        flex-direction: column;
        height: 100vh;
    }
    .header{
        text-align: left;
        padding: 10px 10px 0px 10px;
        border-bottom: 3px solid #ffcc00;
        display: flex;
    }
    .header .logo img{
        height: 100px;
    }
    #time{
        font-size: 3rem;
        font-weight: bold;
        text-align: center;
        line-height: 2;
        padding-left: 30px;
    }


    .pager{
        padding: 5px 15px;
        display: flex;
        justify-content: space-between;
        
        max-width: 800px;
        margin: auto;
    }
    .icon-btn{
        font-size: 2rem;
        border-radius: 50%;
        cursor: pointer;

        transition: all .5s;
    }
    .icon-btn:hover{
        background: #00000022;
    }

    .reload{
        padding: 20px;
    }

    .body{
        flex: 1;

        user-select: none;
    }
    .calendar{
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
        width: 100%;
    }
    .calendar > .first-week{
        display: flex;
        height: 2rem;
        width: 100%;
        /* border-bottom: 1px solid #cbcbcb; */
    }
    .calendar > .first-week > div{
        flex: 1;
        color: #a6a6a6;
    }
    .calendar > .week{
        display: flex;
        flex: 1;
        width: 100%;
        border-top: 1px solid #a6a6a6;
    }
    .calendar > .week > div{
        flex: 1;
        padding: 1px;
        cursor: pointer;
        margin: 0px 5px;
        transition: all .2s;
        overflow: hidden;
    }
    .calendar > .week > div:hover{
        background-color: #f5f5f5;
    }

    .calendar > .week > div > .day-number{
        display: inline-block;
        padding: 2px;
        width: 25px;
        height: 25px;
        line-height: 1.35;
    }
    .calendar > .week > div.today > .day-number{
        background-color: #000000;
        border-radius: 50%;
        color: #fff;
    }

    .calendar > .week > div.sun > .day-number{
        color: #00f;
    }
    .calendar > .week > div.sat > .day-number{
        color: #f00;
    }

    .calendar > .week > div.today.sun > .day-number{
        background-color: #00f;
        color: #fff;
    }
    .calendar > .week > div.today.sat > .day-number{
        background-color: #f00;
        color: #fff;
    }
    .calendar > .week > div > .events{
        overflow: hidden;
        height: 100%;
        width: 100%;
    }
    .calendar > .week > div > .events > .event{
        display: block;
        overflow: hidden;
        border-radius: 2px;
        margin: 1px;
        padding: 1px;
        background-color: #00e68e;
        font-size: 0.9rem;
        max-height: 1.5rem;
    }



    .info{
        border-top: 2px solid skyblue;
        position: fixed;
        bottom: 0px;
        left: 0px;
        width: 100%;
        height: 80vh;
        background-color: white;
        padding: 10px;
        overflow: scroll;
    }

    .info .close{
        float: right;
        font-size: 4rem;
        font-weight: bold;
        position: relative;
        right: 17px;
        top: -15px;
        user-select: none;
        cursor: pointer;
        transition: all .25s;
    }

    .info .close:hover{
        color: #ffcc00;
    }

    .info-day{
        font-size: 2rem;
        font-weight: bold;
        text-align: left;
    }

    .info-weather{
        display: flex;
        max-width: 500px;
        margin: 10px auto;
        background-color: #bfffe4;
        border-radius: 5px;
        padding: 10px;

        display: flex;
        flex-direction: column;
        justify-content: left;
    }
    .info-weather-left-weather-text{
        margin: 0 0 20px 20px;

        border-left: 10px #0073ff solid;
        padding-left: 5px;
        font-size: 2rem;

        text-align: left;
    }
    .info-weather-day{
        flex: 1;
        font-size: 1.5rem;
    }
    .weather-max{
        color: #f00;
    }
    .weather-min{
        color: #0096ff;
    }
    .weathers{
        display: flex;
        justify-content: center;
    }
    .weather > div:first-child{
        margin-right: 10px;
    }
    .weather{
        display: flex;
        font-size: 1.6rem;
        flex: 1;
        justify-content: center;
    }
    /* .info-weather-right{
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    .info-weather-right-body{
        flex: 1;
    }
    .info-weather-right > div{
        display: flex;
    }
    .info-weather-right > div > div{
        flex: 1;
    } */

    
    .info-events{
        display: flex;
        flex-direction: column;
        justify-content: center;
        width: 100%;
        max-width: 500px;
        margin: auto;
    }

    .info-event{
        display: flex;
        width: 100%;
        height: 70px;
        padding: 10px;
        cursor: pointer;
    }
    .info-event-time{
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 60px;
        justify-content: center;
    }
    .info-event-time > div{
        flex: 1;
    }
    .info-event-from > div{
        flex: 1;
    }
    .info-event-title{
        display: flex;
        flex-direction: column;
        justify-content: center;
        flex: 1;
        border-left: 2px solid #00e68e;
        text-align: left;
        padding-left: 10px;
    }
    .info-vote{
        margin-top: 10px;
        margin-left: 20px;

        border: 1px solid #00e68e;
        border-top: none;

        min-height: 100px;
        width: 100%;

        padding: 10px;
    }
    .info-vote-header{
        text-align: left;

        padding: 5px;
        border-bottom: 1px solid #01e68e;
    }
    .info-vote-title{
        font-size: 1.5rem;
    }
    .info-vote-desc{
        font-style: italic;
        color: gray;
    }
    .info-vote-body{
        padding: 10px;
        display: flex;
    }
    .info-vote-body > div{
        flex: 1;
    }
    .info-vote-btn{
        padding: 0.5rem 1rem;
        margin: 5px;
        flex: 1;
        cursor: pointer;
        border: 5px solid #fff;
    }
    .vote-active{
        border-color: #ffd100;
    }
    .vote-yes{
        background: #01e68e;
    }
    .vote-no{
        background: #ff8d8d;
    }

    .info-vote-bar-wrapper{
        padding: 10px;
    }
    .info-vote-bar{
        padding: 5px;
        background: #9f9f9f;
        width: 100%;
        height: 30px;
    }
    .info-vote-bar > .info-vote-bar-yes{
        background-color: #00e68e;
        height: 100%;

        z-index: 1;
        position: relative;

        transition: all .5s;
    }
    .info-vote-bar > .info-vote-bar-no{
        height: 100%;
        width: 100%;
        background-color: #f00;

        float: left;
    }
    .info-vote-vs{
        display: flex;
        justify-content: center;
        padding: 10px;
    }
    .info-vote-vs > div{
        padding: 10px;
    }
    

    .no-action{
        pointer-events: none;
    }


    @media screen and (max-width: 850px) {
        .user-profile > span{
            font-size: 3rem;
        }

        .logo img{
            height: 60px !important;
        }
        #time{
            font-size: 1.2rem;
            padding-left: 10px;
            line-height: 2.6;
        }

        .calendar{
            height: auto;
        }

        .calendar > .week{
            height: 80px;
            flex: 0;
        }
        .calendar > .week > div{
            height: 80px;
            width: 50px;
        }

        .calendar > .week > div > .events > .event{
            font-size: 0.5rem;
            max-height: 0.9rem;
        }
    }


    .now::before{
        content: "";
        display: inline-block;
        height: 10px;
        width: 10px;
        border-radius: 50%;
        border: 2px solid #fff;

        animation: circle 1s infinite;
    }
    .now-black::before{
        color: #000;
    }
    @keyframes circle {
        0% {
            transform: scale(0.1);
            border-width: 5px;
        }
        60% {
            opacity: 1;
        }
        100% {
            border-width: 2px;
            transform: scale(1.5);
            opacity: 0;
        }
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />


<a class="user-profile" style="display: none;" href="/profile">
    <span class="material-symbols-outlined">
        account_circle
    </span>
</a>
<div class="calendar-wrapper">
    <div class="header">
        <div class="logo">
            <img src="/logo" alt="ロゴ">
        </div>
        <div id="time"></div>
        <div class="reload">
            <span class="material-symbols-outlined icon-btn reload-btn" style="padding: 3px;font-size: 3rem;">
                refresh
                </span>
        </div>
    </div>
    <div class="body">
        <div class="pager">
            <div class="prev-page">
                <span class="material-symbols-outlined icon-btn">
                    chevron_left
                    </span>
            </div>
            <div class="next-page">
                <span class="material-symbols-outlined icon-btn">
                    chevron_right
                    </span>
            </div>
        </div>
        <div class="calendar" id="calendar">
        </div>
    </div>
    <div class="info" id="info" style="padding: 0;height: 0;">
        <div class="close" id="close">×</div>
        <div class="info-day">
            
        </div>

        <span class="material-symbols-outlined icon-btn" id="show-weather" style="padding: 5px;">
            sunny
            </span>
        <div style="display: none;" id="info-weather-wrapper">

        <div class="info-weather">
            <div class="info-weather-left">
                <div class="info-weather-left-weather-text">
                    お天気
                </div>
            </div>
            <div class="info-weather-center">
                <img id="weather-icon" class="info-weather-icon">
            </div>
            <div class="info-weather-right">
                <div class="weathers">
                    <div class="weather-max weather">
                        <div>最高</div>
                        <div><span id="weather-max">20</span>度</div>
                    </div>
                    <div class="weather-min weather">
                        <div>最低</div>
                        <div><span id="weather-min">6</span>度</div>
                    </div>
                </div>
                <div class="weather">
                    <div>降水確率</div>
                    <div><span id="weather-rain">30</span>%</div>
                </div>
                <div class="weather">
                    <div>1日降水量</div>
                    <div><span id="weather-rains">30</span> mm</div>
                </div>
            </div>
        </div>

        </div>


        <div class="info-events"></div>

        <div id="info-add-event" class="btn btn-success">予定を追加</div>
    </div>

    <script>
        let isOpenInfo = false;

        const infoHeight = "80vh";
        const color_table = {
            red    : "#ff3b3b",
            green  : "#00e68e",
            blue   : "#3359ff",
            skyblue: "#10faff",
            yellow : "#edce00",
            pink   : "#ffa1ff",
            purple : "#b859ff"
        };
        const color_table2 = {
            red    : "#fff",
            green  : "#000",
            blue   : "#fff",
            skyblue: "#000",
            yellow : "#000",
            pink   : "#000",
            purple : "#fff"
        }
        const MY_NAME = "{{myname}}";

        function parseTime(dt=new Date()){
            return dt.getFullYear()+"-"+("0"+(dt.getMonth()+1)).slice(-2)+"-"+("0"+dt.getDate()).slice(-2);
        }

        async function writeCalendar(time){
            if(loadingSchedule) return;
            loadingSchedule = true;

            if(time == undefined) time = new Date(Number(await $.get("/api/v1/today/")));

            const d = new Date(time);

            const Y = d.getFullYear();
            const M = d.getMonth();

            $("body").css("pointer-events", "none");

            $("#calendar").html("<div class=\"spinner-border text-info\" role=\"status\"><span class=\"visually-hidden\">Loading...</span></div>");
            
            schedule = await $.getJSON("/api/v1/calendar/"+Y+"/"+M+"/");

            let isUsersUndefined = false;
            if(Object.keys(users).length == 0) isUsersUndefined = true;

            users    = await $.getJSON("/api/v1/users/");

            if(isUsersUndefined){
                $(".user-profile").fadeIn(500).children("span").css("color", GetColorFromUser(MY_NAME));
            }


            $("#time").text(Y+" / "+(M+1));
            $("#calendar").html(GetCalendarHtml(Y, M, schedule));


            $("body").css("pointer-events", "all");

            y = Y;
            m = M;

            loadingSchedule = false;

            weather = await $.getJSON("/api/v1/weather/");
        }


        function GetCalendarHtml(y=2024, m=4, events={1:[{title: ""}]}){
            let html = "";

            const currentMonthDays = new Date(y, m, 0).getDate();

            html += "<div class=\"first-week\">"
                + "<div>日</div>"
                + "<div>月</div>"
                + "<div>火</div>"
                + "<div>水</div>"
                + "<div>木</div>"
                + "<div>金</div>"
                + "<div>土</div>"
                + "</div>";
            
            const first_day = new Date(y, m, 1).getDay();
            
            let day = -first_day;

            const today = new Date();

            for(let i=0; i<6; i++){
                html += "<div class=\"week\">";
                for (let i = 0; i < 7; i++) {
                    day++;

                    
                    if(day > 0 && day <= currentMonthDays){
                        html += "<div class=\"day"
                        
                        if(y == today.getFullYear() && m == today.getMonth() && day == today.getDate()){
                            html += " today";
                        }
                        if(i == 0) html += " sun";
                        if(i == 6) html += " sat";
                        
                        html += "\">";

                        html += "<div class=\"day-number\">"+day+"</div>";    
                        
                        html += "<div class=\"events\">"
                        
                        // console.log(events);
                        if(events[day] != undefined){
                            
                            const list = Object.keys(events[day]);

                            for(let i = 0; list.length > i; i++){
                                const el = list[i];
                                if(el == "i") continue;
                                const ev = events[day][el];

                                const textColor = GetColor2FromUser(ev.user);

                                let addClass = "";

                                if(isVote(ev.vote)){
                                    addClass += " now";
                                    if(textColor == "#000") addClass += " now-black";
                                }

                                html += `
                                <div class="event${addClass}" style="background-color: ${GetColorFromUser(ev.user)};color: ${textColor};">
                                    ${ev.title}
                                </div>
                                `;
                            }
                            
                        }

                        html += "</div>";


                        html += "</div>";

                    }else{
                        html += "<div class=\"day\"></div>";
                    }
                }
                html += "</div>";
            }
                
            return html;
        }

        function closeInfo(){
            isOpenInfo = false;
            infoDay = -1;
            $(".body").removeClass("no-action");
            return new Promise((r)=>{
                $("#info").animate({height: "0px", padding: "0px"}, 1000, ()=>{
                    r();
                });
            });
        }
        
        function openInfo(){
            isOpenInfo = true;
            $(".body").addClass("no-action");
            return new Promise((r)=>{
                $("#info").animate({height: infoHeight, padding: "10px"}, 600, ()=>{
                    r();
                });
            });
        }

        function GetDayInfoEventsHtml(){
            let html = "";
            
            if(schedule[infoDay] != undefined){
                const list = Object.keys(schedule[infoDay]);
                for(let i = 0; i < list.length; i++){
                    const id = list[i];
                    if(id == "i") continue;
                    const json = schedule[infoDay][id];

                    let vote_html = "";
                    if(json.vote != undefined){
                        const all = json.vote.yes.length + json.vote.no.length;
                        if(json.vote.vote) vote_html = `
                        <div class="info-vote">
                            <div class="info-vote-header">
                                <div class="info-vote-title">投票</div>
                                <div class="info-vote-desc">あなたはこの予定に賛成ですか？反対ですか？</div>
                            </div>
                            <div class="info-vote-body" data-id="${id}">
                                <div class="info-vote-btn vote-yes${json.vote.yes.indexOf(MY_NAME) != -1 ? " vote-active" : ""}">賛成</div>
                                <div class="info-vote-btn vote-no${json.vote.no.indexOf(MY_NAME) != -1 ? " vote-active" : ""}">反対</div>
                            </div>
                            <div class="info-vote-bar">
                                <div class="info-vote-bar-no" style="width: ${
                                    all == 0 ? 0 : 100
                                }%;"></div>
                                <div class="info-vote-bar-yes" style="width: ${
                                    all == 0 ? 0 : ((json.vote.yes.length/all)*100)
                                }%;"></div>
                            </div>
                            <div class="info-vote-vs">
                                <div>${json.vote.yes.length}</div>
                                <div>vs</div>
                                <div>${json.vote.no.length}</div>    
                            </div>
                        </div>`;
                        else vote_html = `
                        <div class="info-vote">
                            <div class="info-vote-header">
                                <div class="info-vote-title">投票結果</div>
                                <div class="info-vote-desc"></div>
                            </div>
                            <div class="info-vote-bar">
                                <div class="info-vote-bar-no" style="width: ${
                                    all == 0 ? 0 : 100
                                }%;"></div>
                                <div class="info-vote-bar-yes" style="width: ${
                                    all == 0 ? 0 : ((json.vote.yes.length/all)*100)
                                }%;"></div>
                            </div>
                            <div class="info-vote-vs">
                                <div>${json.vote.yes.length}</div>
                                <div>vs</div>
                                <div>${json.vote.no.length}</div>    
                            </div>
                        </div>
                        `;
                    }

                    html += `
                    <div class="info-event-wrapper">
                        <div class="info-event" data-id="${id}">
                            <div class="info-event-time">
                                ${json.from == ""?`終日`:`<div>${json.from}</div><div>${json.to}</div>`}
                            </div>
                            
                            <div class="info-event-title" style="border-left-color: ${GetColorFromUser(json.user)};">
                                ${json.title}
                            </div>

                            <div class="info-event-user">
                                ${json.user}
                            </div>
                        </div>
                        ${vote_html}
                    </div>`;
                }
            }
            
            return html;
        }

        function writeInfo(){
            const d = new Date(y, m, infoDay);
            
            // define month and day
            const month = d.getMonth();
            const day = d.getDate();

            const time = parseTime(d);
            if(weather[time]){
                $("#weather-max").text(weather[time].max);
                $("#weather-min").text(weather[time].min);
                $("#weather-rain").text(weather[time].rain ?? "?");
                $("#weather-rains").text(weather[time].rains);
                $("#weather-icon").attr("src", "/image/weather/icon/"+(weatherTable[weather[time].code] ?? 0));
                
                $("#show-weather").show();
                $("#info-weather-wrapper").hide();
            }else{
                $("#info-weather-wrapper").hide();
                $("#show-weather").hide();
            }

            $(".info-day").text(month+1 + "月" + day + "日 " + dayTable[d.getDay()] + "曜日");
            $(".info-events").html(GetDayInfoEventsHtml());
        }
        function GetColorFromUser(user=""){
            return color_table[
                (users[user] ?? {color: "green"})
                    .color
            ];
        }
        function GetColor2FromUser(user=""){
            return color_table2[
                (users[user] ?? {color: "green"})
                    .color
            ];
        }
        function isVote(vote){
            if(vote == undefined) return false;
            return vote.vote;
        }

        
        let animation = false;
        
        let y = 0;
        let m = 0;
        
        let infoDay   = null;
        
        let loadingSchedule = false;


        let schedule = {};
        let users    = {};
        let weather  = {};

        const dayTable = ["日","月","火","水","木","金","土"];
        const weatherTable = {"0":"1","1":"2","2":"3","3":"3","45":"7","48":"7","51":"5","53":"5","55":"5","61":4,"63":5,"65":5,"66":"7","67":"7","71":"4","73":"5","75":"5","77":"7","80":"4","81":"5","82":"5","85":"7","86":"7","95":"6","96":"6","99":"6"};
        


        writeCalendar();

        $(".prev-page").on("click", ()=>{
            writeCalendar(new Date(y, m-1, 1));
        });
        $(".next-page").on("click", ()=>{
            writeCalendar(new Date(y, m+1, 1));
        });

        $("#close").on("click", ()=>{
            if(animation) return;
            animation = true;
            closeInfo().then(()=>{
                animation = false;
            });
        });

        $("#calendar").on("click", ".day", function(){
            let day = $(this).children(".day-number");
            if(day[0] == undefined) return;

            day = day.text();

            if(infoDay == day) return;
            infoDay = day;

            writeInfo();
            openInfo();
        });

        $(".info-events").on("click", ".info-event", function(){
            const id = $(this).data("id");

            if(id == null || id == undefined) return;

            const info = schedule[infoDay][id];

            Swal.fire({
                title: info.title,
                text: (info.from==""?"終日":info.from+" 〜 "+info.to)+"\nFrom "+info.user,
                [info.user == MY_NAME || true ? "showDenyButton" : ""] : true,
                [info.user == MY_NAME ? "showCancelButton" : "_2"] : true,
                confirmButtonText: info.user == MY_NAME ? (
                    isVote(info.vote) ? "投票を終了" : "投票を開始"
                ) : "閉じる",
                denyButtonText: "削除",
                cancelButtonText: "閉じる"
            }).then((result) => {

                if (result.isDenied) {
                    Swal.fire({
                        title: "削除してもよろしいですか？",
                        text: "",
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonText: "はい",
                        denyButtonText: "いいえ"
                    }).then(result=>{
                        if(result.isConfirmed){
                            $.ajax({
                                "url": "/api/v1/calendar/"+y+"/"+m+"/",
                                "data": {
                                    "id": id,
                                    "day": infoDay,
                                    "type": "delete"
                                },
                                "method": "post",
                                "dataType": "json"
                            });
                            Swal.fire("削除しました！", "", "success").then(()=>{
                                writeCalendar(new Date(y, m, 1));
                                writeInfo();
                            });
                        }
                    });
                }

                if (result.isConfirmed) {
                    if(info.user == MY_NAME)
                        if(!isVote(info.vote)){
                            // 開始
                            $.ajax({
                                "url": "/api/v1/calendar/"+y+"/"+m+"/",
                                "data": {
                                    "id": id,
                                    "day": infoDay,
                                    "type": "vote",
                                    "vote_type": "start"
                                },
                                "method": "POST",
                                "dataType": "json"
                            });
                            Swal.fire("投票を開始しました！", "", "success").then(()=>{
                                writeCalendar(new Date(y, m, 1)).then(()=>{
                                    writeInfo();
                                });
                            });
                        }else{
                            // 終了
                            $.ajax({
                                "url": "/api/v1/calendar/"+y+"/"+m+"/",
                                "data": {
                                    "id": id,
                                    "day": infoDay,
                                    "type": "vote",
                                    "vote_type": "finish"
                                },
                                "method": "POST",
                                "dataType": "json"
                            });
                            Swal.fire("投票を終了しました", "", "success").then(()=>{
                                writeCalendar(new Date(y, m, 1)).then(()=>{
                                    writeInfo();
                                });
                            });
                        }
                }
            });
            
        });
        
        $(".info-events").on("click", ".info-vote-btn", function(){
            const t = $(this);

            const id = t.parent().data("id");
    
            const voteType = t.hasClass("vote-yes") ? "yes" : "no";
            const voteType_reverse = voteType == "yes" ? "no" : "yes";
            const clicked  = t.hasClass("vote-active");

            if(clicked){
                $.ajax({
                    "url": "/api/v1/calendar/"+y+"/"+m+"/",
                    "data": {
                        "id": id,
                        "day": infoDay,
                        "type": "vote",
                        "vote_type": "unvote",
                        "unvote": voteType
                    },
                    "method": "POST",
                    "dataType": "json"
                });
                Swal.fire("投票をキャンセルしました", "", "success").then(()=>{
                    writeCalendar(new Date(y, m, 1)).then(()=>{
                        writeInfo();
                    });
                });
            }else{

                $.ajax({
                    "url": "/api/v1/calendar/"+y+"/"+m+"/",
                    "data": {
                        "id": id,
                        "day": infoDay,
                        "type": "vote",
                        "vote_type": "unvote",
                        "unvote": voteType_reverse
                    },
                    "method": "POST",
                    "dataType": "json"
                });
                $.ajax({
                    "url": "/api/v1/calendar/"+y+"/"+m+"/",
                    "data": {
                        "id": id,
                        "day": infoDay,
                        "type": "vote",
                        "vote_type": "vote",
                        "vote": voteType
                    },
                    "method": "POST",
                    "dataType": "json"
                });

                Swal.fire("投票しました", "", "success").then(()=>{
                    writeCalendar(new Date(y, m, 1)).then(()=>{
                        writeInfo();
                    });
                });

            }
        });

        $("#info-add-event").on("click", ()=>{
            location.href = "/add/"+y+"/"+m+"/"+infoDay+"/";
        });

        $(".reload-btn").on("click", ()=>{
            writeCalendar(new Date(y, m, 1)).then(()=>{
                if(isOpenInfo){
                    writeInfo();
                }
            });
        });

        $("#show-weather").on("click",()=>{
            $("#info-weather-wrapper").show();
            $("#show-weather").hide();
        });
        
    </script>
</div>
